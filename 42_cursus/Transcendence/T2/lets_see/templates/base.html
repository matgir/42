{% load static %}
<!DOCTYPE html>
{% load i18n %}
<html lang="{{ LANGUAGE_CODE }}">
	<!-- {% if messages %}
		<ul class=""messages>
			{% for message in messages %}
				<li class="{{ message.tags }}">
					{{ message }}
				</li>
			{% endfor %}
		</ul>
	{% endif %} -->
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>
			{% block title %}
			Entropia
			{% endblock %}
		</title>
		
		<!-- Fonts et CSS -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;800&display=swap" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/gh/KLA6/cannon-es-umd@v0.20.0/cannon-es.umd.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.min.js"></script>
		<script src="{% static 'js/auth.js' %}"></script>
		<script type="module" src="{% static 'router.js' %}"></script>
		<link rel="stylesheet" href="{% static 'css/home.css' %}">
		<style>

		nav {
			font-family: "roboto";
			display: flex;
			justify-content: space-between;  /* logo à gauche / liens à droite */
			align-items: center;             /* les aligner verticalement */
			padding: 10px;
			position: absolute;
			width: 100%;
			background: transparent;
			background: none;
 			/* border: 1px solid rgb(255, 255, 255); */
			 z-index: 3;
		}

		.nav-middle {
			display: flex;
			align-items: center;
		}

		.nav-right {
			display: flex;
			flex-direction: row;
		}

		nav a {
			font-weight: 600;
			text-decoration: none;
			margin: 0px 10px;
			padding: 8px 8px;
			color: #9a98983d;
			border-radius: 5px;
			/* border: solid 1px #ffffff; */
			background: transparent;
			background: none;
		}

		.search-form {
			display: flex;
			align-items: center;
			justify-content: center;
			flex-direction: row;
			margin-top: 14px;
			margin-right: 0px;
			margin-bottom: 10px;

		}

		.avatar-nav {
			border-radius: 50%;
			width: 40px;
			height: 40px;
			margin-right: 10px;
			align-self: center;
			cursor: pointer;
		}

		.search-form-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.search-results-dropdown {
			display: absolute;
			top: 100%;
			left: 0;
			width: 100%;
			background-color: #333;
			border: 1px solid #555;
			border-radius: 4px;
			z-index: 10;
		}

		.search-form input {
			margin-top: 0px;
			margin-bottom: 0px;
			padding: 8px;
			margin-right: 0px;
			border: solid 1px rgba(255, 255, 255, 0.41);
		}
		

		.home-logo:hover {
			background: none;
		}

		.home-logo img {
			height: 45px;
			width: auto;
			transition: transform 0.2s ease;
		}

		.home-logo:hover img {
			transform: scale(1.1);
		}


		.link_temp , .link_temp_logout, .link_temp_langue{
		font-weight: 400;
		font-size: 15px;
		padding: 7px 17px;
		color: rgba(255, 255, 255, 0.711);
		background: none;
		border-radius: 5px;
		cursor: pointer;
		font-family: "Roboto", sans-serif;
		border: solid 1px rgba(255, 255, 255, 0.461);
		text-align: center;
		top: 14%;
		}
		.link_temp_logout {
			background:rgb(0, 0, 222) ;
			border: none;
			color: rgba(255, 255, 255, 0.704);

			font-family: "Roboto", sans-serif;
			font-weight: 700;
			top: 30px;
		}

		.link_temp_langue{
			font-family: "Roboto", sans-serif;
			font-weight: 100;

			margin-right:3px ;
			padding-left: 10px; 
			padding-right: 10px;
			color: rgba(255, 255, 255, 0.601);
			background:rgba(200, 200, 255, 0.089) ;
			border: none;
		}
		.link_temp_logout {
			background:rgb(0, 0, 222) ;
			border: none;
			color: rgba(255, 255, 255, 0.704);

			font-family: "Roboto", sans-serif;
			font-weight: 700;
			top: 30px;
		}

		.link_temp_langue{
			right: 200px;
			top: 30px;
			font-family: "Roboto", sans-serif;
			font-weight: 100;

			margin-right:8px ;
			padding-left: 8px; 
			padding-right: 8px;
			padding-left: 4px;

			color: rgba(255, 255, 255, 0.356);
			background:rgba(200, 200, 255, 0.074) ;
			border: none;
		}

		.link_temp:hover {
		transform: scale(1.05);
		}


		.search-form {
		font-weight: 400;
		font-size: 11px;
		padding: 3px 15px;
		color: rgba(255, 255, 255, 0.711);
		background: none;
		border-radius: 5px;
		cursor: pointer;
		font-family: "Roboto", sans-serif;
		/* border: solid 1px rgba(255, 255, 255, 0.461); */
		text-align: left;
		margin-right: 0px;
		border: none;

		
		}

		.search-form2 {
			margin-top: 0px;
		font-weight: 400;
		font-size: 14px;
		padding: 6px 17px;
		color: rgba(255, 255, 255, 0.434);
		margin-left: 14px;
		background: none;
		border-radius: 5px;
		cursor: pointer;
		font-family: "Roboto", sans-serif;
		border: solid 1px rgba(255, 255, 255, 0.461);
		text-align: center;
		margin-left: 7px;

		
		}

		.message-popup {
			position: fixed;
			bottom: 20px;
			right: 20px;
			min-width: 250px;
			padding: 15px;
			border-radius: 8px;
			color: white;
			font-size: 16px;
			display: none;
			opacity: 0;
			transition: opacity 0.5s ease-in-out;
			z-index: 1000;
			}
			/* .message-popup.success { background-color: #001aff; } Green */
			.message-popup.success { background-color: #4CAF50; } /* Green */
			.message-popup.error { background-color: #f44336; } /* Red */
			/* .message-popup.error { background-color: #ffab0e; } Red */
			.message-popup.warning { background-color: #ff9800; } /* Orange */
			/* .message-popup.warning { background-color: #b20cff; } Orange */
			.message-popup.show {
				display: block;
				opacity: 1;
			}

		/* Style for the results dropdown */
		#search-results-dropdown {
			position: absolute;
			/* top: 100%; Position below the form */
			/* left: 0; Align with the form */
			background-color: #333; /* Dark background */
			border: 1px solid #555;
			border-radius: 4px;
			max-height: 200px; /* Limit height */
			overflow-y: auto; /* Add scroll if needed */
			z-index: 10; /* Ensure it's above other elements */
			display: none; /* Hidden by default */
			min-width: 150px; /* Minimum width */
			margin-top: 5px; /* Space between input and dropdown */
		}

		#search-results-dropdown a {
			display: block;
			padding: 8px 12px;
			color: #eee;
			text-decoration: none;
			font-size: 14px;
		}

		#search-results-dropdown a:hover {
			background-color: #555;
		}

		/* End style for dropdown */

		</style>
	

	 <link rel="icon" href="{% static 'icons/icon4/favicon-96x96.png' %}" type="image/png">	
			
	</head>
	<body>
		<nav>
			<div class="nav-left">
				<a href="{% url 'home' %}" class="home-logo">
					<img src="{% static 'logo/logo_square.png' %}" alt="Logo">
				</a>
			</div>
		
			{% if user.is_authenticated %}
				<div class="nav-middle" style="display: flex; flex-direction: row; align-items: center;">
					<div class="search-form-container">
						<form class="search-form" id="search-friend-form" method="GET" action="/api/users/search_friends/" data-no-spa>
							{% csrf_token %}
							<input class="search-form" id="search-friend-input" type="text" name="q" placeholder="{% trans 'Search friends' %}" required autocomplete="off">
						</form>
						<div id="search-results-dropdown" class="search-results-dropdown"></div>
					</div>
					<!-- Container for search results dropdown -->
				</div>
			{% endif %}
			<div class="nav-right">
				<form action="{% url 'set_language' %}" method="post">
				{% csrf_token %}
				<select class="link_temp_langue" name="language" onchange="this.form.submit()">
					{% get_current_language as LANGUAGE_CODE %}
					{% get_available_languages as LANGUAGES %}
					{% for lang in LANGUAGES %}
						<option value="{{ lang.0 }}" {% if lang.0 == LANGUAGE_CODE %}selected{% endif %}>
							{{lang.1}}
						</option>
					{% endfor %}
					</select>
				</form>
				{% if user.is_authenticated %}
				<a href="/users/my_profile/" style="align-self: center;">
					<img src="{{ user.avatar.url }}" class="avatar-nav" alt="Avatar">
				</a>
				<form method="post" action="/api/users/accounts/logout/" data-no-spa>
					{% csrf_token %}
					<button type="submit" class="link_temp_logout">
						{% trans "Logout" %}
					</button>
				</form>
				{% endif %}
			</div>
		</nav>
		
		<div id="app-content">
			<!-- This is where SPA content will be loaded by router.js -->
		</div>
	
		<!-- Message Pop-up Container -->
		<div id="message-popup" class="message-popup"></div>
	
		<script src="{% url 'javascript-catalog' %}?lang={{ LANGUAGE_CODE }}">
		</script>
		<script>
			document.addEventListener("DOMContentLoaded", function() {
				const messagePopup = document.getElementById("message-popup");
				
				{% if messages %}
				let messages = [
					{% for message in messages %}
					{ text: "{{ message|escapejs }}", tag: "{{ message.tags }}" },
					{% endfor %}
				];
				function showMessage(index) {
					if (index < messages.length) {
						let msg = messages[index];
						
						messagePopup.innerText = msg.text;
						messagePopup.className = "message-popup " + msg.tag + " show";
						
						setTimeout(() => {
							messagePopup.classList.remove("show");
							setTimeout(() => {
								showMessage(index + 1);
							}, 500);  // Delay before next message
						}, 3000);  // Message duration
					}
				}
				
				showMessage(0);
				{% endif %}

				// Search dropdown logic
				const searchForm = document.getElementById('search-friend-form');
				const searchInput = document.getElementById('search-friend-input');
				const resultsDropdown = document.getElementById('search-results-dropdown');

				if (searchForm && searchInput && resultsDropdown) {
					searchInput.addEventListener('input', function(e) {
						const query = e.target.value.trim();

						if (query.length > 0) { // Minimum characters to trigger search (optional)
							fetch(`/api/users/search_friends/?q=${encodeURIComponent(query)}`, {
								method: 'GET',
								headers: {
									'X-Requested-With': 'XMLHttpRequest', // Identify as AJAX request
									'Accept': 'application/json'
								}
							})
							.then(response => response.json())
							.then(data => {
								resultsDropdown.innerHTML = ''; // Clear previous results
								if (data.results && data.results.length > 0) {
									data.results.forEach(user => {
										const link = document.createElement('a');
										link.href = user.profile_url; // Use the URL from JSON
										link.textContent = user.username;
										link.dataset.spaLink = ''; // Ensure SPA routing handles this link if needed
										resultsDropdown.appendChild(link);
									});
									resultsDropdown.style.display = 'block'; // Show dropdown
								} else {
									resultsDropdown.style.display = 'none'; // Hide if no results
								}
							})
							.catch(error => {
								console.error('Error fetching search results:', error);
								resultsDropdown.style.display = 'none';
							});
						} else {
							resultsDropdown.innerHTML = '';
							resultsDropdown.style.display = 'none'; // Hide if query is empty
						}
					});

					// Prevent default form submission (which causes page reload)
					searchForm.addEventListener('submit', function(e) {
						e.preventDefault();
						// Optionally, you could redirect to the first result or a dedicated search page here
						// For now, just preventing the reload is enough for the dropdown.
						console.log("Form submission prevented. Handled by input event.");
					});

					// Hide dropdown when clicking outside
					document.addEventListener('click', function(e) {
						if (!searchForm.contains(e.target)) {
							resultsDropdown.style.display = 'none';
						}
					});
				}
				// End Search dropdown logic
			});
			
			const ws_sheme = window.location.protocol === "https:" ? "wss" : "ws";
			
			const socket = new WebSocket(ws_sheme + '://' + window.location.host + '/ws/status/');
			
			socket.onopen = function(e) {
				console.log("WebSocket connected");
			}
			
			socket.onclose = function(e) {
				console.log("WebSocket disconnected");
			}
			
			</script>
			<script>
				function checkURLandToggleNav() {
				  const path = window.location.pathname;
				  const nav = document.querySelector('nav');
			  
				  if (!nav) return;
			  
				  if (path.includes('/users/accounts/two_factor/')) {
					nav.style.display = 'none';
				  } else {
					nav.style.display = ''; // reset to default (usually 'block' or CSS-defined)
				  }
				}
			  
				// Run on initial load
				checkURLandToggleNav();
			  
				// Listen for URL changes
				window.addEventListener('popstate', checkURLandToggleNav);
			  
				// Patch pushState and replaceState
				const originalPushState = history.pushState;
				history.pushState = function () {
				  originalPushState.apply(this, arguments);
				  checkURLandToggleNav();
				};
			  
				const originalReplaceState = history.replaceState;
				history.replaceState = function () {
				  originalReplaceState.apply(this, arguments);
				  checkURLandToggleNav();
				};
			</script>  
	</body>
	</html>
	

